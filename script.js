/* i18n + behavior */
const translations = {
  en: {
    "nav.booking": "Book",
    "site.title":"Svetlana — Esthetician",
    "nav.home":"Home",
    "nav.services":"Services",
    "nav.contact":"Contact",
    "footer.rights":"All rights reserved.",
    "hero.title":"Glowing skin, science-backed care",
    "hero.subtitle":"Facials, waxing & sugaring in a calm, welcoming studio.",
    "hero.cta":"See services",
    "highlights.experience":"years of esthetics experience",
    "highlights.experience.more":"Thousands of safe, effective treatments delivered with consistent results.",
    "highlights.medschool.title":"Medical",
    "highlights.medschool.text":"international studies background",
    "highlights.medschool.more":"Every protocol is grounded in skin anatomy, hygiene, and evidence-based care.",
    "highlights.approach":"Unique mix of science and care for your skin",
    "highlights.approach.more":"A personalized, gentle approach that puts comfort and real results first.",
    "services.title":"Services & Pricing",
    "services.subtitle":"A few popular options below — reach out for a personalized plan.",
    "contact.title":"Book & Contact",
    "contact.subtitle":"Send a message on Instagram or by email — I’ll reply quickly.",
    "contact.email":"Email",
    "contact.hours":"Hours",
    "contact.hoursText":"By appointment. Weekends available.",
    "services.ctaTitle":"Not sure what to choose?",
    "services.ctaText":"Message me with your skin goals — I’ll recommend the best treatment.",
    "services.ctaBtn":"Get in touch",
    "gallery.caption1":"Relaxing facials",
    "gallery.caption2":"Waxing & sugaring",
    "gallery.caption3":"Clean, safe products",
    "about.title":"Hi, I’m Svetlana",
    "about.text":"I combine advanced techniques with a gentle approach to help you feel confident in your skin.",
    "about.point1":"Customized facials for every skin type",
    "about.point2":"Waxing & sugaring for smooth results",
    "about.point3":"Safe, hygienic, and results-focused",
    "about.cta":"Book or ask a question",

    /* --- Booking page --- */
    "booking.title": "Book an Appointment",
    "booking.subtitle": "Choose your preferred service and time below. You’ll receive a confirmation by email.",
    "booking.serviceLabel": "Service",
    "booking.dateLabel": "Date",
    "booking.timeLabel": "Time",
    "booking.nameLabel": "Name",
    "booking.emailLabel": "Email ",
    "booking.phoneLabel": "Phone ",
    "booking.namePH": "Your name",
    "booking.emailPH": "you@example.com",
    "booking.phonePH": "+1 514-555-0123",
    "booking.slotHelp": "Pick a free time.",
    "booking.submit": "Book Appointment",
    "booking.opt.ultra": "Facial — Ultrasound (50 min)",
    "booking.opt.combined": "Facial — Combined (60 min)",
    "booking.opt.wax": "Waxing / Sugaring (45 min)",
    "booking.opt.prx": "PRX-T33 (60 min)",
    "booking.opt.micro": "Microneedling (75 min)"
  },

  fr: {
    "nav.booking": "Réserver",
    "site.title":"Svetlana — Esthéticienne",
    "nav.home":"Accueil",
    "nav.services":"Prestations",
    "nav.contact":"Contact",
    "footer.rights":"Tous droits réservés.",
    "hero.title":"Peau lumineuse, soins fondés sur la science",
    "hero.subtitle":"Soins du visage, cire & sugaring dans un studio apaisant.",
    "hero.cta":"Voir les prestations",
    "highlights.experience":"ans d’expérience en esthétisme",
    "highlights.experience.more":"Des milliers de soins réalisés en toute sécurité avec des résultats constants.",
    "highlights.medschool.title":"Médical",
    "highlights.medschool.text":"parcours d’études internationales",
    "highlights.medschool.more":"Chaque protocole s’appuie sur l’anatomie cutanée, l’hygiène et les preuves scientifiques.",
    "highlights.approach":"Un mélange unique de science et de douceur",
    "highlights.approach.more":"Une approche personnalisée et douce pour votre confort et de vrais résultats.",
    "services.title":"Prestations & Tarifs",
    "services.subtitle":"Quelques options populaires — contactez-moi pour un plan personnalisé.",
    "contact.title":"Réserver & Contact",
    "contact.subtitle":"Écrivez sur Instagram ou par e-mail — réponse rapide.",
    "contact.email":"E-mail",
    "contact.hours":"Horaires",
    "contact.hoursText":"Sur rendez-vous. Week-end possible.",
    "services.ctaTitle":"Vous hésitez ?",
    "services.ctaText":"Écrivez-moi vos objectifs peau — je vous conseillerai.",
    "services.ctaBtn":"Me contacter",
    "gallery.caption1":"Soins relaxants",
    "gallery.caption2":"Cire & sugaring",
    "gallery.caption3":"Produits sûrs et propres",
    "about.title":"Bonjour, je suis Svetlana",
    "about.text":"J’allie techniques avancées et douceur pour révéler votre peau.",
    "about.point1":"Soins du visage personnalisés",
    "about.point2":"Épilation à la cire & au sucre",
    "about.point3":"Sûr, hygiénique et orienté résultats",
    "about.cta":"Réserver ou poser une question",

    /* --- Booking page --- */
    "booking.title": "Réserver un rendez-vous",
    "booking.subtitle": "Choisissez votre prestation et l’horaire. Vous recevrez une confirmation par e-mail.",
    "booking.serviceLabel": "Prestation",
    "booking.dateLabel": "Date",
    "booking.timeLabel": "Heure",
    "booking.nameLabel": "Nom",
    "booking.emailLabel": "E-mail",
    "booking.phoneLabel": "Téléphone",
    "booking.namePH": "Votre nom",
    "booking.emailPH": "vous@exemple.com",
    "booking.phonePH": "+1 514-555-0123",
    "booking.slotHelp": "Choisissez un créneau libre.",
    "booking.submit": "Réserver",
    "booking.opt.ultra": "Soin visage — Ultrasons (50 min)",
    "booking.opt.combined": "Soin visage — Combiné (60 min)",
    "booking.opt.wax": "Épilation cire / sugaring (45 min)",
    "booking.opt.prx": "PRX-T33 (60 min)",
    "booking.opt.micro": "Microneedling (75 min)"
  },

  ru: {
    "nav.booking": "Запись",
    "site.title":"Светлана — Эстетист",
    "nav.home":"Главная",
    "nav.services":"Услуги",
    "nav.contact":"Контакты",
    "footer.rights":"Все права защищены.",
    "hero.title":"Здоровая сияющая кожа с научным подходом",
    "hero.subtitle":"Чистки лица, воск и шугаринг в уютном кабинете.",
    "hero.cta":"Посмотреть услуги",
    "highlights.experience":"лет опыта в эстетике",
    "highlights.experience.more":"Тысячи процедур выполнены безопасно и с предсказуемым результатом.",
    "highlights.medschool.title":"Мед.",
    "highlights.medschool.text":"международное образование",
    "highlights.medschool.more":"Каждый протокол основан на анатомии кожи, гигиене и доказательной базе.",
    "highlights.approach":"Уникальное сочетание науки и заботы",
    "highlights.approach.more":"Индивидуальный, бережный подход с упором на комфорт и реальный результат.",
    "services.title":"Услуги и цены",
    "services.subtitle":"Популярные варианты ниже — напишите для персональной схемы.",
    "contact.title":"Запись и контакты",
    "contact.subtitle":"Пишите в Instagram или на e-mail — отвечу быстро.",
    "contact.email":"E-mail",
    "contact.hours":"Часы работы",
    "contact.hoursText":"По записи. Возможны выходные.",
    "services.ctaTitle":"Не знаете, что выбрать?",
    "services.ctaText":"Напишите ваши цели — подскажу оптимальный уход.",
    "services.ctaBtn":"Связаться",
    "gallery.caption1":"Расслабляющие уходы",
    "gallery.caption2":"Воск и шугаринг",
    "gallery.caption3":"Чистые и безопасные средства",
    "about.title":"Привет, я Светлана",
    "about.text":"Совмещаю современные методики и бережный подход, чтобы вы чувствовали уверенность в своей коже.",
    "about.point1":"Индивидуальные уходы для любого типа кожи",
    "about.point2":"Воск и шугаринг с гладким результатом",
    "about.point3":"Безопасно, гигиенично и с акцентом на результат",
    "about.cta":"Записаться или задать вопрос",

    /* --- Booking page --- */
    "booking.title": "Записаться на приём",
    "booking.subtitle": "Выберите услугу и время. Подтверждение придёт на e-mail.",
    "booking.serviceLabel": "Услуга",
    "booking.dateLabel": "Дата",
    "booking.timeLabel": "Время",
    "booking.nameLabel": "Имя",
    "booking.emailLabel": "E-mail",
    "booking.phoneLabel": "Телефон",
    "booking.namePH": "Ваше имя",
    "booking.emailPH": "you@example.com",
    "booking.phonePH": "+1 514-555-0123",
    "booking.slotHelp": "Выберите свободное время.",
    "booking.submit": "Записаться",
    "booking.opt.ultra": "Уход для лица — Ультразвук (50 мин)",
    "booking.opt.combined": "Уход для лица — Комбинированная чистка (60 мин)",
    "booking.opt.wax": "Воск / шугаринг (45 мин)",
    "booking.opt.prx": "PRX-T33 (60 мин)",
    "booking.opt.micro": "Микронидлинг (75 мин)"
  }
};


function i18nApply(lang){const d=translations[lang]||translations.en;document.documentElement.lang=lang;document.querySelectorAll("[data-i18n]").forEach(el=>{const k=el.getAttribute("data-i18n");if(d[k]) el.textContent=d[k];});document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{const k=el.getAttribute("data-i18n-placeholder");if(d[k]) el.setAttribute("placeholder", d[k]);});document.title=d["site.title"];localStorage.setItem("lang",lang);document.querySelectorAll(".lang").forEach(b=>b.classList.toggle("active", b.dataset.lang===lang));}
function initLang(){const saved=localStorage.getItem("lang");const browser=(navigator.language||"en").slice(0,2);const initial=saved||(["en","fr","ru"].includes(browser)?browser:"en");i18nApply(initial);}
function handleSubmit(e){e.preventDefault();const lang=document.documentElement.lang;const el=document.getElementById("form-status");el.textContent=lang==="fr"?"Merci ! Votre message a été enregistré (démo).":(lang==="ru"?"Спасибо! Сообщение сохранено (демо).":"Thanks! Your message was recorded (demo).");e.target.reset();return false;}
document.addEventListener("DOMContentLoaded",()=>{initLang();document.querySelectorAll(".lang").forEach(btn=>btn.addEventListener("click",()=>i18nApply(btn.dataset.lang)));const here=location.pathname.split('/').pop()||"index.html";document.querySelectorAll(".nav a").forEach(a=>{if(a.getAttribute("href")===here)a.setAttribute("aria-current","page");});});


// === Booking API ===
// Use the exec URL that works for you (googleusercontent.com or script.google.com):
const BOOKING_ENDPOINT = 'https://script.google.com/macros/s/AKfycbwdaEiLpLNSxsK4W3YOWy8HVswTx-HDgBhFFd59Gn9qvhc_GAPF6p6yz7dRqY-G5nkP/exec';
const STUDIO_ADDRESS = '2824 Rue Frégault, Laval, QC, Canada';

// ---------- helpers ----------
const $ = (sel) => document.querySelector(sel);

function serviceMinutes() {
  const opt = $('select[name="service"]').selectedOptions[0];
  return parseInt(opt?.dataset?.min || '60', 10);
}

function setMinDateToday() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  const today = `${yyyy}-${mm}-${dd}`;
  const dateEl = $('input[name="date"]');
  if (dateEl) dateEl.min = today;
}

// ---------- availability loader (:00 / :30 only) ----------
async function loadAvailableSlots() {
  const serviceEl = $('select[name="service"]');
  const dateEl    = $('input[name="date"]');
  const timeSel   = $('#timeSelect'); // <select id="timeSelect" name="time">
  const slotHelp  = $('#slotHelp');   // <small id="slotHelp">
  const submitBtn = $('button[type="submit"]');

  if (!serviceEl || !dateEl || !timeSel) return;

  // Reset UI
  timeSel.innerHTML = '<option value="" disabled selected>--:--</option>';
  if (slotHelp) slotHelp.textContent = '';
  if (submitBtn) submitBtn.disabled = true;

  const dateStr = dateEl.value;
  if (!dateStr || !serviceEl.value) return;

  const minutes = serviceMinutes();

  try {
    const url = `${BOOKING_ENDPOINT}?action=slots&date=${encodeURIComponent(dateStr)}&duration=${minutes}`;
    const res = await fetch(url);
    const raw = await res.text();
    const json = JSON.parse(raw);

    if (!res.ok || !json.ok) throw new Error(json.error || 'Failed to load availability.');

    // Keep only :00 and :30 starts
    const filtered = (json.slots || []).filter(s => {
      const d = new Date(s.startISO);
      const mins = d.getMinutes();
      return mins === 0 || mins === 30;
    });

    if (!filtered.length) {
      if (slotHelp) slotHelp.textContent = 'No available times on this day.';
      submitBtn && (submitBtn.disabled = true);
      return;
    }

    // Fill dropdown
    filtered.forEach(s => {
      const d  = new Date(s.startISO);
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0'); // 00 or 30
      const opt = document.createElement('option');
      opt.value = `${hh}:${mm}`;            // what we submit
      opt.textContent = `${hh}:${mm}`;      // displayed label
      timeSel.appendChild(opt);
    });

    if (slotHelp) slotHelp.textContent = `Select one of ${filtered.length} time${filtered.length>1?'s':''}.`;
    submitBtn && (submitBtn.disabled = false);
  } catch (err) {
    if (slotHelp) slotHelp.textContent = 'Could not load availability. Please try again.';
    submitBtn && (submitBtn.disabled = true);
  }
}

// ---------- booking submit (disables btn + replaces form) ----------
async function createBookingViaAPI(e){
  e.preventDefault();

  const f = e.target;
  const btn = f.querySelector('button[type="submit"]');
  const status = document.getElementById('bookStatus');

  // read inputs
  const service = f.service.value;
  const dateStr = f.date.value;                 // YYYY-MM-DD
  const timeStr = f.time.value;                 // HH:MM (from #timeSelect)
  const name    = f.name.value.trim();
  const email   = f.email.value.trim();
  const phone   = f.phone.value.trim();
  const minutes = parseInt(f.service.selectedOptions[0].dataset.min, 10) || 60;

  if (!dateStr || !timeStr) {
    status.textContent = 'Please pick a date and time.';
    return false;
  }

  // build start ISO
  const [hh, mm] = (timeStr || '00:00').split(':').map(Number);
  const start = new Date(dateStr + 'T00:00');
  start.setHours(hh, mm, 0, 0);

  // Simple POST body (no preflight)
  const params = new URLSearchParams({
    name,
    email,
    phone,
    service,
    date: dateStr,
    time: timeStr,
    startISO: start.toISOString(),
    durationMin: String(minutes),
    location: STUDIO_ADDRESS
  });

  // UI: disable while processing
  const original = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Booking…';
  status.textContent = 'Booking…';

  try {
    const res  = await fetch(BOOKING_ENDPOINT, { method: 'POST', body: params });
    const raw  = await res.text();
    let json; try { json = JSON.parse(raw); } catch { throw new Error(raw || 'Invalid server response'); }

    // Handle conflict (HTTP 409) — time got taken in parallel
    if (res.status === 409 || json.conflict) {
      status.textContent = '❌ That time was just taken. Reloading available times…';
      await loadAvailableSlots();
      btn.disabled = true;
      btn.textContent = original;
      return false;
    }

    if (!res.ok || !json.ok) throw new Error(json.error || 'Unknown error');

    // Replace the whole booking block with confirmation
    const bookingSection = document.querySelector('.booking');
    const prettyDate = (() => {
      const when = new Date(dateStr + 'T00:00'); when.setHours(hh, mm, 0, 0);
      return when.toLocaleString([], { weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    })();

    bookingSection.innerHTML = `
      <h1>Thank you!</h1>
      <p class="ok">Your appointment has been booked.</p>
      <div class="card" style="border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-top:10px">
        <p><b>Service:</b> ${service}</p>
        <p><b>When:</b> ${prettyDate}</p>
        <p><b>Location:</b> ${STUDIO_ADDRESS}</p>
      </div>
      <p style="margin-top:16px">You should receive a confirmation email shortly.</p>
    `;

    return false; // stop; form is gone now
  } catch (err) {
    status.textContent = '❌ Booking failed: ' + (err.message || err);
  } finally {
    // If form still exists, re-enable the button
    if (document.body.contains(btn)) {
      btn.disabled = false;
      btn.textContent = original;
    }
  }

  return false;
}

// ---------- wire up on load ----------
document.addEventListener('DOMContentLoaded', () => {
  setMinDateToday();
  const svc  = $('select[name="service"]');
  const date = $('input[name="date"]');
  if (svc)  svc.addEventListener('change', loadAvailableSlots);
  if (date) date.addEventListener('change', loadAvailableSlots);

  // Load slots immediately if a date is preselected
  if (date && date.value) loadAvailableSlots();
});
